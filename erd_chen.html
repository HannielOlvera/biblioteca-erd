<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ERD (Chen) - Biblioteca (basado en SQL, sin tablas N:M)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --ink:#1f2937; --ink-soft:#374151; --panel:#f7f7f8; --panel-border:#e5e7eb;
    --accent:#2563eb;
  }
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--ink); background:var(--bg);
    display:flex; flex-direction:column; min-height:100%;
  }
  header{
    display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem;
    background:var(--panel); border-bottom:1px solid var(--panel-border);
    position:sticky; top:0; z-index:10;
  }
  header h1{margin:0; font-size:16px; font-weight:600}
  .controls{margin-left:auto; display:flex; gap:.5rem; flex-wrap:wrap}
  button{
    appearance:none; border:1px solid var(--panel-border); background:#fff; color:var(--ink);
    padding:.45rem .7rem; border-radius:.5rem; cursor:pointer; font-size:13px; font-weight:500;
  }
  button.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  main{flex:1; display:flex; min-height:0}
  #graphWrap{flex:1; overflow:auto; position:relative}
  #graph{min-width:1400px; min-height:800px; display:flex; align-items:center; justify-content:center}
  .legend{
    position:absolute; right:12px; bottom:12px; z-index:5;
    background:rgba(255,255,255,.95); border:1px solid var(--panel-border); border-radius:.5rem;
    padding:.5rem .7rem; font-size:12px; color:var(--ink-soft)
  }
  .legend ul{margin:.25rem 0 0 1rem; padding:0}
</style>
</head>
<body>
<header>
  <h1>ERD (Chen) – Biblioteca</h1>
  <div class="controls">
    <label style="display:flex;align-items:center;gap:.4rem;font-size:13px">
      <input type="checkbox" id="simpleToggle" /> Modo simple (sin atributos)
    </label>
    <button id="relayoutBtn">Recalcular diseño</button>
    <button id="exportSvgBtn">Exportar SVG</button>
    <button id="exportPngBtn" class="primary">Exportar PNG</button>
  </div>
</header>

<main>
  <div id="graphWrap">
    <div id="graph"></div>
    <div class="legend">
      Basado en el SQL físico (sin tablas N:M).<br/>
      Notación Chen:
      <ul>
        <li>Entidad: rectángulo</li>
        <li>Relación: rombo</li>
        <li>Atributo: óvalo (PK marcado)</li>
        <li>Cardinalidad: 1, N en los lados</li>
      </ul>
      <div style="font-size:12px;color:#6b7280;margin-top:.25rem">Tip: Usa “Modo simple” para cero cruces.</div>
    </div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
<script>
const baseGraphAttrs = `
  graph [
    rankdir=LR, splines=ortho, overlap=false,
    pad="0.3", nodesep="0.45", ranksep="0.9",
    compound=true, concentrate=true, bgcolor="white"
  ];
  node  [fontname="Arial", fontsize=12, color="#0f172a", style=filled, fillcolor="white", penwidth=1.2];
  edge  [fontname="Arial", fontsize=11, color="#334155", penwidth=1.1];
`;

/* ENTIDADES (solo tablas del SQL que no son N:M) */
const entities = `
  Usuario   [shape=box, label="Usuario",   fillcolor="#e7f0ff"];
  Tipo_Usuario [shape=box, label="Tipo_Usuario", fillcolor="#e7f0ff"];
  Direccion [shape=box, label="Direccion", fillcolor="#e7f0ff"];
  Colonia   [shape=box, label="Colonia",   fillcolor="#e7f0ff"];
  Ciudad    [shape=box, label="Ciudad",    fillcolor="#e7f0ff"];
  Estado    [shape=box, label="Estado",    fillcolor="#e7f0ff"];
  Editorial [shape=box, label="Editorial", fillcolor="#e7f0ff"];
  Tipo_Libro[shape=box, label="Tipo_Libro",fillcolor="#e7f0ff"];
  Idioma    [shape=box, label="Idioma",    fillcolor="#e7f0ff"];
  Genero    [shape=box, label="Genero",    fillcolor="#e7f0ff"];
  Autor     [shape=box, label="Autor",     fillcolor="#e7f0ff"];
  Libro     [shape=box, label="Libro",     fillcolor="#e7f0ff"];
  Ejemplar  [shape=box, label="Ejemplar",  fillcolor="#e7f0ff"];
  Prestamo  [shape=box, label="Prestamo",  fillcolor="#e7f0ff"];
`;

/* RELACIONES (incluyendo N:M como rombos, sin mostrar tablas de unión) */
const relationships = `
  R_Usuario_Tipo   [shape=diamond, label="es_de",        fillcolor="#fff3cd"];
  R_Usuario_Dir    [shape=diamond, label="vive_en",      fillcolor="#fff3cd"];
  R_Dir_Col        [shape=diamond, label="pertenece",    fillcolor="#fff3cd"];
  R_Col_Ciu        [shape=diamond, label="pertenece",    fillcolor="#fff3cd"];
  R_Ciu_Est        [shape=diamond, label="pertenece",    fillcolor="#fff3cd"];
  R_Lib_Editorial  [shape=diamond, label="publicado_por",fillcolor="#fff3cd"];
  R_Lib_Tipo       [shape=diamond, label="es_tipo",      fillcolor="#fff3cd"];
  R_Lib_Idioma     [shape=diamond, label="en_idioma",    fillcolor="#fff3cd"];
  R_Lib_Autor      [shape=diamond, label="escribe",      fillcolor="#fff3cd"];
  R_Lib_Genero     [shape=diamond, label="clasifica",    fillcolor="#fff3cd"];
  R_Lib_Ejemplar   [shape=diamond, label="tiene",        fillcolor="#fff3cd"];
  R_Prestamo_Usuario [shape=diamond, label="realiza",    fillcolor="#fff3cd"];
  R_Prestamo_Ejemplar[shape=diamond, label="contiene",   fillcolor="#fff3cd"];
`;

/* ATRIBUTOS (PK y esenciales). Para evitar “encimados”, los edges no afectan el layout (constraint=false) */
const attributesFull = `
  // Usuario
  a_u_pk [shape=ellipse, label="PK ID_usu", fillcolor="#eafaf1"];
  a_u_nom [shape=ellipse, label="Nombre", fillcolor="#eafaf1"];
  a_u_ape [shape=ellipse, label="Apellido", fillcolor="#eafaf1"];
  a_u_fn [shape=ellipse, label="FechaNac", fillcolor="#eafaf1"];
  a_u_email [shape=ellipse, label="Email", fillcolor="#eafaf1"];
  a_u_tel [shape=ellipse, label="Telefono", fillcolor="#eafaf1"];
  a_u_gen [shape=ellipse, label="Genero", fillcolor="#eafaf1"];

  // Tipo_Usuario
  a_tu_pk [shape=ellipse, label="PK ID_tipousu", fillcolor="#eafaf1"];
  a_tu_desc [shape=ellipse, label="Descripcion", fillcolor="#eafaf1"];

  // Direccion
  a_dir_pk [shape=ellipse, label="PK ID_direccion", fillcolor="#eafaf1"];
  a_dir_calle [shape=ellipse, label="Calle", fillcolor="#eafaf1"];
  a_dir_ne [shape=ellipse, label="NumeroExterior", fillcolor="#eafaf1"];
  a_dir_ni [shape=ellipse, label="NumeroInterior", fillcolor="#eafaf1"];
  a_dir_ref [shape=ellipse, label="Referencia", fillcolor="#eafaf1"];

  // Colonia
  a_col_pk [shape=ellipse, label="PK ID_colonia", fillcolor="#eafaf1"];
  a_col_nom [shape=ellipse, label="Nombre", fillcolor="#eafaf1"];
  a_col_cp [shape=ellipse, label="CP", fillcolor="#eafaf1"];

  // Ciudad
  a_ciu_pk [shape=ellipse, label="PK ID_ciudad", fillcolor="#eafaf1"];
  a_ciu_nom [shape=ellipse, label="Nombre", fillcolor="#eafaf1"];

  // Estado
  a_est_pk [shape=ellipse, label="PK ID_estado", fillcolor="#eafaf1"];
  a_est_nom [shape=ellipse, label="Nombre", fillcolor="#eafaf1"];

  // Editorial
  a_ed_pk [shape=ellipse, label="PK ID_editorial", fillcolor="#eafaf1"];
  a_ed_nom [shape=ellipse, label="Nombre", fillcolor="#eafaf1"];

  // Tipo_Libro
  a_tl_pk [shape=ellipse, label="PK ID_tipolibro", fillcolor="#eafaf1"];
  a_tl_desc [shape=ellipse, label="Descripcion", fillcolor="#eafaf1"];

  // Idioma
  a_idi_pk [shape=ellipse, label="PK ID_idioma", fillcolor="#eafaf1"];
  a_idi_desc [shape=ellipse, label="Descripcion", fillcolor="#eafaf1"];

  // Genero
  a_gen_pk [shape=ellipse, label="PK ID_genero", fillcolor="#eafaf1"];
  a_gen_desc [shape=ellipse, label="Descripcion", fillcolor="#eafaf1"];

  // Autor
  a_aut_pk [shape=ellipse, label="PK ID_autor", fillcolor="#eafaf1"];
  a_aut_nom [shape=ellipse, label="Nombre", fillcolor="#eafaf1"];
  a_aut_ape [shape=ellipse, label="Apellido", fillcolor="#eafaf1"];

  // Libro
  a_lib_pk [shape=ellipse, label="PK ID_libro", fillcolor="#eafaf1"];
  a_lib_tit [shape=ellipse, label="Titulo", fillcolor="#eafaf1"];
  a_lib_sub [shape=ellipse, label="Subtitulo", fillcolor="#eafaf1"];
  a_lib_isbn13 [shape=ellipse, label="ISBN13", fillcolor="#eafaf1"];
  a_lib_isbn10 [shape=ellipse, label="ISBN10", fillcolor="#eafaf1"];
  a_lib_ed [shape=ellipse, label="Edicion", fillcolor="#eafaf1"];
  a_lib_anio [shape=ellipse, label="AnioPublicacion", fillcolor="#eafaf1"];

  // Ejemplar
  a_ej_pk [shape=ellipse, label="PK ID_ejemplar", fillcolor="#eafaf1"];
  a_ej_cb [shape=ellipse, label="CodigoBarras", fillcolor="#eafaf1"];
  a_ej_ubi [shape=ellipse, label="Ubicacion", fillcolor="#eafaf1"];
  a_ej_estado [shape=ellipse, label="EstadoEjemplar", fillcolor="#eafaf1"];

  // Prestamo
  a_pre_pk [shape=ellipse, label="PK ID_prestamo", fillcolor="#eafaf1"];
  a_pre_fp [shape=ellipse, label="FechaPrestamo", fillcolor="#eafaf1"];
  a_pre_fde [shape=ellipse, label="FechaDevolucionEsperada", fillcolor="#eafaf1"];
  a_pre_fdr [shape=ellipse, label="FechaDevolucionReal", fillcolor="#eafaf1"];
  a_pre_status [shape=ellipse, label="Status", fillcolor="#eafaf1"];
`;

/* Edges de atributos sin influir el layout (constraint=false) para evitar encimados */
const attributeEdges = `
  Usuario -> a_u_pk [arrowhead=none, constraint=false];
  Usuario -> a_u_nom [arrowhead=none, constraint=false];
  Usuario -> a_u_ape [arrowhead=none, constraint=false];
  Usuario -> a_u_fn [arrowhead=none, constraint=false];
  Usuario -> a_u_email [arrowhead=none, constraint=false];
  Usuario -> a_u_tel [arrowhead=none, constraint=false];
  Usuario -> a_u_gen [arrowhead=none, constraint=false];
  Tipo_Usuario -> a_tu_pk [arrowhead=none, constraint=false];
  Tipo_Usuario -> a_tu_desc [arrowhead=none, constraint=false];
  Direccion -> a_dir_pk [arrowhead=none, constraint=false];
  Direccion -> a_dir_calle [arrowhead=none, constraint=false];
  Direccion -> a_dir_ne [arrowhead=none, constraint=false];
  Direccion -> a_dir_ni [arrowhead=none, constraint=false];
  Direccion -> a_dir_ref [arrowhead=none, constraint=false];
  Colonia -> a_col_pk [arrowhead=none, constraint=false];
  Colonia -> a_col_nom [arrowhead=none, constraint=false];
  Colonia -> a_col_cp [arrowhead=none, constraint=false];
  Ciudad -> a_ciu_pk [arrowhead=none, constraint=false];
  Ciudad -> a_ciu_nom [arrowhead=none, constraint=false];
  Estado -> a_est_pk [arrowhead=none, constraint=false];
  Estado -> a_est_nom [arrowhead=none, constraint=false];
  Editorial -> a_ed_pk [arrowhead=none, constraint=false];
  Editorial -> a_ed_nom [arrowhead=none, constraint=false];
  Tipo_Libro -> a_tl_pk [arrowhead=none, constraint=false];
  Tipo_Libro -> a_tl_desc [arrowhead=none, constraint=false];
  Idioma -> a_idi_pk [arrowhead=none, constraint=false];
  Idioma -> a_idi_desc [arrowhead=none, constraint=false];
  Genero -> a_gen_pk [arrowhead=none, constraint=false];
  Genero -> a_gen_desc [arrowhead=none, constraint=false];
  Autor -> a_aut_pk [arrowhead=none, constraint=false];
  Autor -> a_aut_nom [arrowhead=none, constraint=false];
  Autor -> a_aut_ape [arrowhead=none, constraint=false];
  Libro -> a_lib_pk [arrowhead=none, constraint=false];
  Libro -> a_lib_tit [arrowhead=none, constraint=false];
  Libro -> a_lib_sub [arrowhead=none, constraint=false];
  Libro -> a_lib_isbn13 [arrowhead=none, constraint=false];
  Libro -> a_lib_isbn10 [arrowhead=none, constraint=false];
  Libro -> a_lib_ed [arrowhead=none, constraint=false];
  Libro -> a_lib_anio [arrowhead=none, constraint=false];
  Ejemplar -> a_ej_pk [arrowhead=none, constraint=false];
  Ejemplar -> a_ej_cb [arrowhead=none, constraint=false];
  Ejemplar -> a_ej_ubi [arrowhead=none, constraint=false];
  Ejemplar -> a_ej_estado [arrowhead=none, constraint=false];
  Prestamo -> a_pre_pk [arrowhead=none, constraint=false];
  Prestamo -> a_pre_fp [arrowhead=none, constraint=false];
  Prestamo -> a_pre_fde [arrowhead=none, constraint=false];
  Prestamo -> a_pre_fdr [arrowhead=none, constraint=false];
  Prestamo -> a_pre_status [arrowhead=none, constraint=false];
`;

/* Relaciones con cardinalidad. Los diamonds están colocados entre clusters para reducir cruces */
const relationshipEdges = `
  Usuario -> R_Usuario_Tipo [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Usuario_Tipo -> Tipo_Usuario [dir=none];
  Usuario -> R_Usuario_Dir [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Usuario_Dir -> Direccion [dir=none];
  Direccion -> R_Dir_Col [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Dir_Col -> Colonia [dir=none];
  Colonia -> R_Col_Ciu [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Col_Ciu -> Ciudad [dir=none];
  Ciudad -> R_Ciu_Est [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Ciu_Est -> Estado [dir=none];
  Libro -> R_Lib_Editorial [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Lib_Editorial -> Editorial [dir=none];
  Libro -> R_Lib_Tipo [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Lib_Tipo -> Tipo_Libro [dir=none];
  Libro -> R_Lib_Idioma [dir=none, taillabel="N", labeldistance=1.5, headlabel="1"];
  R_Lib_Idioma -> Idioma [dir=none];
  Libro -> R_Lib_Autor [dir=none, taillabel="N", labeldistance=1.5, headlabel="N"];
  R_Lib_Autor -> Autor [dir=none];
  Libro -> R_Lib_Genero [dir=none, taillabel="N", labeldistance=1.5, headlabel="N"];
  R_Lib_Genero -> Genero [dir=none];
  Libro -> R_Lib_Ejemplar [dir=none, taillabel="1", labeldistance=1.3, headlabel="N"];
  R_Lib_Ejemplar -> Ejemplar [dir=none];
  Usuario -> R_Prestamo_Usuario [dir=none, taillabel="1", labeldistance=1.3, headlabel="N"];
  R_Prestamo_Usuario -> Prestamo [dir=none];
  Prestamo -> R_Prestamo_Ejemplar [dir=none, taillabel="N", labeldistance=1.5, headlabel="N"];
  R_Prestamo_Ejemplar -> Ejemplar [dir=none];
`;

/* Clústeres y rangos para minimizar cruces y “encimados” */
const clusters = `
  subgraph cluster_geo { label="Geografía"; color="#e5e7eb";
    Estado; Ciudad; Colonia; Direccion; R_Ciu_Est; R_Col_Ciu; R_Dir_Col;
  }
  subgraph cluster_users { label="Usuarios"; color="#e5e7eb";
    Usuario; Tipo_Usuario; R_Usuario_Tipo; R_Usuario_Dir;
  }
  subgraph cluster_catalogo { label="Catálogo"; color="#e5e7eb";
    Editorial; Tipo_Libro; Idioma; Genero; Autor;
    R_Lib_Editorial; R_Lib_Tipo; R_Lib_Idioma; R_Lib_Autor; R_Lib_Genero;
  }
  subgraph cluster_obras { label="Obras"; color="#e5e7eb";
    Libro; R_Lib_Ejemplar;
  }
  subgraph cluster_inv { label="Inventario"; color="#e5e7eb";
    Ejemplar;
  }
  subgraph cluster_prestamo { label="Préstamos"; color="#e5e7eb";
    Prestamo; R_Prestamo_Usuario; R_Prestamo_Ejemplar;
  }

  // Alineaciones horizontales para lectura
  { rank=same; Estado; Ciudad; Colonia; Direccion; }
  { rank=same; Tipo_Usuario; Usuario; Prestamo; }
  { rank=same; Editorial; Tipo_Libro; Idioma; Libro; Autor; Genero; Ejemplar; }
`;

/* Diagramas: completo (con atributos) y simple (solo entidades + relaciones) */
function buildFullDot(){
  return `
digraph G {
  ${baseGraphAttrs}
  ${entities}
  ${relationships}
  ${clusters}
  ${attributesFull}
  ${attributeEdges}
  ${relationshipEdges}
}
`; }

function buildSimpleDot(){
  return `
digraph G {
  ${baseGraphAttrs}
  ${entities}
  ${relationships}
  ${clusters}
  ${relationshipEdges}
}
`; }

let viz;
async function render(dot){
  if(!viz) viz = new Viz();
  const el = document.getElementById('graph');
  el.innerHTML = '';
  try{
    const svg = await viz.renderSVGElement(dot);
    svg.removeAttribute('width'); svg.removeAttribute('height');
    svg.style.width = '1400px'; svg.style.height = 'auto';
    el.appendChild(svg);
  }catch(err){
    el.innerHTML = '<pre style="padding:1rem;color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;max-width:900px;overflow:auto">'
      + (err.message || String(err)) + '</pre>';
  }
}

function getSVGString(){
  const svg = document.querySelector('#graph svg');
  if(!svg) return null;
  const clone = svg.cloneNode(true);
  clone.style.background = '#ffffff';
  return '<?xml version="1.0" encoding="UTF-8"?>\\n' + new XMLSerializer().serializeToString(clone);
}
function download(name, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function exportSVG(){
  const s = getSVGString(); if(!s) return;
  download('ERD_Biblioteca.svg', new Blob([s], {type:'image/svg+xml'}));
}
function exportPNG(){
  const s = getSVGString(); if(!s) return;
  const img = new Image();
  const blob = new Blob([s], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  img.onload = function(){
    const scale = 2, w = img.width * scale, h = img.height * scale;
    const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0, 0, w, h);
    canvas.toBlob(b => { download('ERD_Biblioteca.png', b); URL.revokeObjectURL(url); }, 'image/png', 1.0);
  };
  img.onerror = function(){ URL.revokeObjectURL(url); alert('No se pudo convertir el SVG a PNG.'); };
  img.src = url;
}

const simpleToggle = document.getElementById('simpleToggle');
document.getElementById('exportSvgBtn').onclick = exportSVG;
document.getElementById('exportPngBtn').onclick = exportPNG;
document.getElementById('relayoutBtn').onclick = ()=> render(simpleToggle.checked ? buildSimpleDot() : buildFullDot());
simpleToggle.onchange = ()=> render(simpleToggle.checked ? buildSimpleDot() : buildFullDot());

// Render inicial
render(buildFullDot());
</script>
</body>
</html>