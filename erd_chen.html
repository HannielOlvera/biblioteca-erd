<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagrama ERD Chen - Sistema Biblioteca</title>
  <meta name="description" content="Diagrama ER (Chen) del sistema Biblioteca con navegaci√≥n simple y exportaci√≥n" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3Eüìä%3C/text%3E%3C/svg%3E" />

  <!-- html2canvas para captura -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1f2937; }

    .header { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,.1); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; gap: .75rem; flex-wrap: wrap; }
    .header h1 { font-size: 1.25rem; font-weight: 600; }
    .controls { display: flex; gap: .5rem; flex-wrap: wrap; }
    .btn { background: #3b82f6; color: #fff; border: none; padding: .5rem .9rem; border-radius: 6px; cursor: pointer; font-size: .875rem; font-weight: 500; text-decoration: none; transition: transform .15s ease, background .15s ease; }
    .btn:hover { background: #2563eb; transform: translateY(-1px); }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover { background: #4b5563; }
    .btn-success { background: #10b981; }
    .btn-success:hover { background: #059669; }

    .container { position: relative; height: calc(100vh - 80px); overflow: hidden; background: #fff; margin: 1rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    #diagram { width: 100%; height: 100%; overflow: hidden; cursor: grab; }
    #diagram:active { cursor: grabbing; }
    #diagram svg { max-width: none !important; max-height: none !important; transform-origin: 0 0; }

    .instructions { position: absolute; top: 1rem; left: 1rem; background: rgba(59,130,246,.08); border: 1px solid rgba(59,130,246,.25); border-radius: 8px; padding: .9rem; max-width: 300px; z-index: 10; }
    .instructions h3 { font-size: .85rem; color: #1d4ed8; margin-bottom: .4rem; }
    .instructions p { font-size: .75rem; color: #374151; line-height: 1.35; }

    .status { position: absolute; bottom: 1rem; left: 1rem; right: 1rem; background: rgba(0,0,0,.8); color: #fff; padding: .5rem 1rem; border-radius: 6px; font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; text-align: center; z-index: 10; }

    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 5; color: #6b7280; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto .75rem; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 13px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,.15); animation: slideIn .25s ease; }
    .toast.error { background: #ef4444; }
    @keyframes slideIn { from{ transform: translateX(100%); opacity: 0 } to{ transform: translateX(0); opacity: 1 } }
    @keyframes slideOut { from{ transform: translateX(0); opacity: 1 } to{ transform: translateX(100%); opacity: 0 } }

    /* Estilos del diagrama (clases del SVG) */
    .box { fill: #fff; stroke: #1f2937; stroke-width: 1.5; }
    .diamond { fill: #f8fafc; stroke: #1f2937; stroke-width: 1.5; }
    .oval { fill: #f1f5f9; stroke: #475569; stroke-width: 1.2; }
    .edge { stroke: #374151; stroke-width: 1.2; fill: none; }
    .label { font: 600 15px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; fill: #111827; }
    .small { font: 500 13px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; fill: #374151; }
    .mini { font: 400 12px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; fill: #4b5563; }

    @media (max-width: 768px) {
      .header { padding: 1rem; flex-direction: column; text-align: center; }
      .controls { justify-content: center; }
      .container { margin: .5rem; height: calc(100vh - 120px); }
      .instructions { position: static; margin: 1rem; max-width: none; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>üìä Diagrama ERD Chen - Sistema Biblioteca</h1>
    <div class="controls">
      <button class="btn" onclick="autoFit()">üéØ Auto-fit</button>
      <button class="btn" onclick="zoomIn()">üîç+</button>
      <button class="btn" onclick="zoomOut()">üîç‚àí</button>
      <button class="btn" onclick="resetView()">‚Üª Reset</button>
      <button class="btn btn-secondary" onclick="printDiagram()">üñ®Ô∏è PDF</button>
      <button class="btn btn-success" onclick="downloadImage()">üì• IMG</button>
      <button class="btn btn-success" onclick="downloadSVG()">üìÑ SVG</button>
      <button class="btn btn-secondary" onclick="showHelp()">‚ùì Ayuda</button>
      <a class="btn btn-secondary" href="index.html">‚Üê Volver</a>
    </div>
  </header>

  <div class="container">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Cargando diagrama...</p>
    </div>

    <div class="instructions">
      <h3>üìñ Navegaci√≥n</h3>
      <p><strong>Arrastrar:</strong> Clic y arrastra<br>
      <strong>Zoom:</strong> Rueda del mouse<br>
      <strong>Auto-fit:</strong> Doble clic<br>
      <strong>Teclado:</strong> Flechas, +/-</p>
    </div>

    <div id="diagram">
      <!-- SVG original, sin scripts externos -->
      <svg id="erd" viewBox="0 0 10000 8000" xmlns="http://www.w3.org/2000/svg">
        <!-- ===================== BANDA SUPERIOR: GEO / USUARIO / PR√âSTAMO ===================== -->
        
        <!-- ESTADO -->
        <g id="Estado">
          <rect class="box" x="400" y="800" width="280" height="60" rx="4"/>
          <text class="label" x="540" y="836" text-anchor="middle">Estado</text>
          
          <ellipse class="oval" cx="300" cy="400" rx="100" ry="26"/><text class="mini" x="300" y="404" text-anchor="middle">ID_estado</text>
          <path class="edge" d="M300 400 L300 500 L400 500 L400 800" />
          
          <ellipse class="oval" cx="700" cy="400" rx="96" ry="26"/><text class="mini" x="700" y="404" text-anchor="middle">Nombre</text>
          <path class="edge" d="M700 400 L700 500 L540 500 L540 800" />
        </g>

        <!-- ESTADO -> CIUDAD -->
        <g id="R_Ciu_Est">
          <polygon class="diamond" points="1050,830 1090,800 1130,830 1090,860"/>
          <text class="small" x="1090" y="836" text-anchor="middle">Pertenece</text>
        </g>
        <path class="edge" d="M680 830 L1050 830" /><text class="small" x="850" y="818">1</text>

        <!-- CIUDAD -->
        <g id="Ciudad">
          <rect class="box" x="1500" y="800" width="280" height="60" rx="4"/>
          <text class="label" x="1640" y="836" text-anchor="middle">Ciudad</h2>
          
          <ellipse class="oval" cx="1400" cy="400" rx="102" ry="26"/><text class="mini" x="1400" y="404" text-anchor="middle">ID_ciudad</text>
          <path class="edge" d="M1400 400 L1400 600 L1500 600 L1500 800" />
          
          <ellipse class="oval" cx="1800" cy="400" rx="96" ry="26"/><text class="mini" x="1800" y="404" text-anchor="middle">Nombre</text>
          <path class="edge" d="M1800 400 L1800 600 L1640 600 L1640 800" />
        </g>
        <path class="edge" d="M1130 830 L1500 830" /><text class="small" x="1300" y="818">N</text>

        <!-- CIUDAD -> COLONIA -->
        <g id="R_Col_Ciu">
          <polygon class="diamond" points="2150,830 2190,800 2230,830 2190,860"/>
          <text class="small" x="2190" y="836" text-anchor="middle">Pertenece</text>
        </g>
        <path class="edge" d="M1780 830 L2150 830" /><text class="small" x="1950" y="818">1</text>

        <!-- COLONIA -->
        <g id="Colonia">
          <rect class="box" x="2600" y="800" width="300" height="60" rx="4"/>
          <text class="label" x="2750" y="836" text-anchor="middle">Colonia</text>
          
          <ellipse class="oval" cx="2500" cy="400" rx="110" ry="26"/><text class="mini" x="2500" y="404" text-anchor="middle">ID_colonia</text>
          <path class="edge" d="M2500 400 L2500 600 L2600 600 L2600 800" />
          
          <ellipse class="oval" cx="2900" cy="400" rx="100" ry="26"/><text class="mini" x="2900" y="404" text-anchor="middle">Nombre</text>
          <path class="edge" d="M2900 400 L2900 600 L2750 600 L2750 800" />
          
          <ellipse class="oval" cx="2900" cy="1100" rx="70" ry="24"/><text class="mini" x="2900" y="1104" text-anchor="middle">CP</text>
          <path class="edge" d="M2750 860 L2750 1000 L2900 1000 L2900 1100" />
        </g>
        <path class="edge" d="M2230 830 L2600 830" /><text class="small" x="2400" y="818">N</text>

        <!-- COLONIA -> DIRECCI√ìN -->
        <g id="R_Dir_Col">
          <polygon class="diamond" points="3300,830 3340,800 3380,830 3340,860"/>
          <text class="small" x="3340" y="836" text-anchor="middle">Pertenece</text>
        </g>
        <path class="edge" d="M2900 830 L3300 830" /><text class="small" x="3100" y="818">1</text>

        <!-- DIRECCI√ìN -->
        <g id="Direccion">
          <rect class="box" x="3750" y="800" width="340" height="60" rx="4"/>
          <text class="label" x="3920" y="836" text-anchor="middle">Direcci√≥n</text>
          
          <ellipse class="oval" cx="3650" cy="400" rx="120" ry="26"/><text class="mini" x="3650" y="404" text-anchor="middle">ID_direccion</text>
          <path class="edge" d="M3650 400 L3650 600 L3750 600 L3750 800" />
          
          <ellipse class="oval" cx="4150" cy="400" rx="100" ry="26"/><text class="mini" x="4150" y="404" text-anchor="middle">Calle</text>
          <path class="edge" d="M4150 400 L4150 600 L3920 600 L3920 800" />
          
          <ellipse class="oval" cx="3650" cy="1200" rx="150" ry="26"/><text class="mini" x="3650" y="1204" text-anchor="middle">NumeroExterior</text>
          <path class="edge" d="M3750 860 L3750 1000 L3650 1000 L3650 1200" />
          
          <ellipse class="oval" cx="4150" cy="1200" rx="150" ry="26"/><text class="mini" x="4150" y="1204" text-anchor="middle">NumeroInterior</text>
          <path class="edge" d="M3920 860 L3920 1000 L4150 1000 L4150 1200" />
          
          <ellipse class="oval" cx="3920" cy="1400" rx="120" ry="26"/><text class="mini" x="3920" y="1404" text-anchor="middle">Referencia</text>
          <path class="edge" d="M3920 860 L3920 1400" />
        </g>
        <path class="edge" d="M3380 830 L3750 830" /><text class="small" x="3560" y="818">N</text>

        <!-- DIRECCI√ìN -> USUARIO -->
        <g id="R_Usr_Dir">
          <polygon class="diamond" points="4500,830 4540,800 4580,830 4540,860"/>
          <text class="small" x="4540" y="836" text-anchor="middle">Vive en</text>
        </g>
        <path class="edge" d="M4090 830 L4500 830" /><text class="small" x="4300" y="818">1</text>

        <!-- USUARIO -->
        <g id="Usuario">
          <rect class="box" x="5000" y="800" width="340" height="60" rx="4"/>
          <text class="label" x="5170" y="836" text-anchor="middle">Usuario</text>
          
          <ellipse class="oval" cx="4900" cy="400" rx="112" ry="26"/><text class="mini" x="4900" y="404" text-anchor="middle">ID_usu</text>
          <path class="edge" d="M4900 400 L4900 600 L5000 600 L5000 800" />
          
          <ellipse class="oval" cx="5170" cy="400" rx="108" ry="26"/><text class="mini" x="5170" y="404" text-anchor="middle">Nombre</text>
          <path class="edge" d="M5170 400 L5170 800" />
          
          <ellipse class="oval" cx="5440" cy="400" rx="108" ry="26"/><text class="mini" x="5440" y="404" text-anchor="middle">Tel√©fono</text>
          <path class="edge" d="M5440 400 L5440 600 L5340 600 L5340 800" />
          
          <ellipse class="oval" cx="4800" cy="1200" rx="116" ry="26"/><text class="mini" x="4800" y="1204" text-anchor="middle">Apellido</text>
          <path class="edge" d="M5000 860 L5000 1000 L4800 1000 L4800 1200" />
          
          <ellipse class="oval" cx="5170" cy="1400" rx="124" ry="26"/><text class="mini" x="5170" y="1404" text-anchor="middle">Email</text>
          <path class="edge" d="M5170 860 L5170 1400" />
          
          <ellipse class="oval" cx="5440" cy="1200" rx="124" ry="26"/><text class="mini" x="5440" y="1204" text-anchor="middle">FechaNac</text>
          <path class="edge" d="M5340 860 L5340 1000 L5440 1000 L5440 1200" />
          
          <ellipse class="oval" cx="5700" cy="1000" rx="96" ry="26"/><text class="mini" x="5700" y="1004" text-anchor="middle">G√©nero</text>
          <path class="edge" d="M5340 830 L5700 830 L5700 974" />
        </g>
        <path class="edge" d="M4580 830 L5000 830" /><text class="small" x="4800" y="818">N</text>

        <!-- ES DE -> TIPO_USUARIO -->
        <g id="R_Usr_Tipo">
          <polygon class="diamond" points="5170,200 5210,170 5250,200 5210,230"/>
          <text class="small" x="5210" y="206" text-anchor="middle">Es de</text>
        </g>
        <path class="edge" d="M5170 400 L5170 230" /><text class="small" x="5155" y="300">N</text>

        <!-- TIPO_USUARIO -->
        <g id="Tipo_Usuario">
          <rect class="box" x="5040" y="50" width="260" height="50" rx="4"/>
          <text class="small" x="5170" y="78" text-anchor="middle">Tipo_Usuario</text>
          
          <ellipse class="oval" cx="5040" cy="50" rx="116" ry="22"/><text class="mini" x="5040" y="54" text-anchor="middle">Descripcion</text>
          <path class="edge" d="M5040 50 L5040 50" />
          
          <ellipse class="oval" cx="5400" cy="50" rx="106" ry="22"/><text class="mini" x="5400" y="54" text-anchor="middle">ID_tipousu</text>
          <path class="edge" d="M5300 50 L5350 50" />
        </g>
        <path class="edge" d="M5210 170 L5170 170 L5170 100" /><text class="small" x="5182" y="130">1</text>

        <!-- USUARIO -> REALIZA -> PR√âSTAMO -->
        <g id="R_Realiza">
          <polygon class="diamond" points="5850,830 5890,800 5930,830 5890,860"/>
          <text class="small" x="5890" y="836" text-anchor="middle">Realiza</text>
          <text class="small" x="5890" y="794" text-anchor="middle">1:N</text>
        </g>
        <path class="edge" d="M5340 830 L5850 830" /><text class="small" x="5600" y="818">1</text>

        <!-- PR√âSTAMO -->
        <g id="Prestamo">
          <rect class="box" x="6300" y="800" width="400" height="60" rx="4"/>
          <text class="label" x="6500" y="836" text-anchor="middle">Pr√©stamo</text>
          
          <ellipse class="oval" cx="6200" cy="400" rx="130" ry="26"/><text class="mini" x="6200" y="404" text-anchor="middle">ID_prestamo</text>
          <path class="edge" d="M6200 400 L6200 600 L6300 600 L6300 800" />
          
          <ellipse class="oval" cx="6600" cy="400" rx="150" ry="26"/><text class="mini" x="6600" y="404" text-anchor="middle">FechaPrestamo</text>
          <path class="edge" d="M6600 400 L6600 600 L6500 600 L6500 800" />
          
          <ellipse class="oval" cx="6200" cy="1200" rx="230" ry="28"/><text class="mini" x="6200" y="1204" text-anchor="middle">FechaDevolucionEsperada</text>
          <path class="edge" d="M6300 860 L6300 1000 L6200 1000 L6200 1200" />
          
          <ellipse class="oval" cx="6600" cy="1200" rx="200" ry="28"/><text class="mini" x="6600" y="1204" text-anchor="middle">FechaDevolucionReal</text>
          <path class="edge" d="M6500 860 L6500 1000 L6600 1000 L6600 1200" />
          
          <ellipse class="oval" cx="6900" cy="830" rx="110" ry="26"/><text class="mini" x="6900" y="834" text-anchor="middle">Status</text>
          <path class="edge" d="M6700 830 L6900 830" />
        </g>
        <path class="edge" d="M5930 830 L6300 830" /><text class="small" x="6120" y="818">*</text>

        <!-- ===================== BANDA MEDIA: LIBRO / TIPO / IDIOMA ===================== -->
        
        <!-- LIBRO -->
        <g id="Libro">
          <rect class="box" x="3500" y="3000" width="500" height="70" rx="4"/>
          <text class="label" x="3750" y="3040" text-anchor="middle">Libro</text>
          
          <ellipse class="oval" cx="3200" cy="2500" rx="115" ry="26"/><text class="mini" x="3200" y="2504" text-anchor="middle">ID_libro</text>
          <path class="edge" d="M3200 2500 L3200 2700 L3500 2700 L3500 3000" />
          
          <ellipse class="oval" cx="3750" cy="2500" rx="105" ry="26"/><text class="mini" x="3750" y="2504" text-anchor="middle">Titulo</text>
          <path class="edge" d="M3750 2500 L3750 3000" />
          
          <ellipse class="oval" cx="4300" cy="2300" rx="160" ry="26"/><text class="mini" x="4300" y="2304" text-anchor="middle">AnioPublicacion</text>
          <path class="edge" d="M4300 2300 L4300 2700 L4000 2700 L4000 3000" />
          
          <ellipse class="oval" cx="3200" cy="3500" rx="125" ry="26"/><text class="mini" x="3200" y="3504" text-anchor="middle">Subtitulo</text>
          <path class="edge" d="M3500 3070 L3500 3300 L3200 3300 L3200 3500" />
          
          <ellipse class="oval" cx="3750" cy="3500" rx="115" ry="26"/><text class="mini" x="3750" y="3504" text-anchor="middle">ISBN13</text>
          <path class="edge" d="M3750 3070 L3750 3500" />
          
          <ellipse class="oval" cx="4300" cy="3500" rx="115" ry="26"/><text class="mini" x="4300" y="3504" text-anchor="middle">ISBN10</text>
          <path class="edge" d="M4000 3070 L4000 3300 L4300 3300 L4300 3500" />
          
          <ellipse class="oval" cx="4600" cy="3300" rx="110" ry="26"/><text class="mini" x="4600" y="3304" text-anchor="middle">Edicion</text>
          <path class="edge" d="M4000 3030 L4300 3030 L4300 3300 L4600 3300" />
        </g>

        <!-- PUBLICADO POR (N:1) - Editorial -->
        <g id="R_Publicado">
          <polygon class="diamond" points="3750,2300 3790,2270 3830,2300 3790,2330"/>
          <text class="small" x="3790" y="2306" text-anchor="middle">Publicado por</text>
        </g>
        <path class="edge" d="M3750 3000 L3750 2330" /><text class="small" x="3765" y="2660">N</text>

        <!-- EDITORIAL -->
        <g id="Editorial">
          <rect class="box" x="3650" y="2000" width="280" height="50" rx="4"/>
          <text class="small" x="3790" y="2030" text-anchor="middle">Editorial</text>
          
          <ellipse class="oval" cx="3400" cy="2000" rx="98" ry="24"/><text class="mini" x="3400" y="2004" text-anchor="middle">Nombre</text>
          <path class="edge" d="M3650 2020 L3450 2000" />
          
          <ellipse class="oval" cx="4200" cy="2000" rx="120" ry="24"/><text class="mini" x="4200" y="2004" text-anchor="middle">ID_editorial</text>
          <path class="edge" d="M3930 2020 L4150 2000" />
        </g>
        <path class="edge" d="M3790 2270 L3790 2050" /><text class="small" x="3800" y="2150">1</text>

        <!-- ES TIPO (N:1) -> TIPO_LIBRO -->
        <g id="R_Tipo">
          <polygon class="diamond" points="5000,3035 5040,3005 5080,3035 5040,3065"/>
          <text class="small" x="5040" y="3041" text-anchor="middle">Es tipo</text>
        </g>
        <path class="edge" d="M4000 3035 L5000 3035" /><text class="small" x="4500" y="3020">N</text>

        <g id="Tipo_Libro">
          <rect class="box" x="5300" y="3000" width="400" height="70" rx="4"/>
          <text class="small" x="5500" y="3040" text-anchor="middle">Tipo_Libro</text>
          
          <ellipse class="oval" cx="5500" cy="2500" rx="150" ry="26"/><text class="mini" x="5500" y="2504" text-anchor="middle">ID_tipolibro</text>
          <path class="edge" d="M5500 2500 L5500 3000" />
          
          <ellipse class="oval" cx="5500" cy="3500" rx="164" ry="26"/><text class="mini" x="5500" y="3504" text-anchor="middle">Descripcion</text>
          <path class="edge" d="M5500 3070 L5500 3500" />
        </g>
        <path class="edge" d="M5080 3035 L5300 3035" /><text class="small" x="5200" y="3020">1</text>

        <!-- EN IDIOMA (N:1) -> IDIOMA -->
        <g id="R_Idioma">
          <polygon class="diamond" points="6300,3035 6340,3005 6380,3035 6340,3065"/>
          <text class="small" x="6340" y="3041" text-anchor="middle">En idioma</text>
        </g>
        <path class="edge" d="M5700 3035 L6300 3035" /><text class="small" x="6000" y="3020">N</text>

        <g id="Idioma">
          <rect class="box" x="6600" y="3000" width="380" height="70" rx="4"/>
          <text class="small" x="6790" y="3040" text-anchor="middle">Idioma</text>
          
          <ellipse class="oval" cx="6790" cy="2500" rx="156" ry="26"/><text class="mini" x="6790" y="2504" text-anchor="middle">ID_idioma</text>
          <path class="edge" d="M6790 2500 L6790 3000" />
          
          <ellipse class="oval" cx="6790" cy="3500" rx="164" ry="26"/><text class="mini" x="6790" y="3504" text-anchor="middle">Descripcion</text>
          <path class="edge" d="M6790 3070 L6790 3500" />
        </g>
        <path class="edge" d="M6380 3035 L6600 3035" /><text class="small" x="6500" y="3020">1</text>

        <!-- ===================== BANDA INFERIOR: AUTOR / G√âNERO / EJMPLAR ===================== -->
        
        <!-- ESCRIBE (N:M) -> AUTOR -->
        <g id="R_Escribe">
          <polygon class="diamond" points="2500,4500 2540,4470 2580,4500 2540,4530"/>
          <text class="small" x="2540" y="4506" text-anchor="middle">Escribe</text>
          <text class="small" x="2580" y="4490">N:M</text>
        </g>
        <path class="edge" d="M3500 3035 L2000 3035 L2000 4500 L2500 4500" />
        <text class="small" x="2150" y="3800">*</text>

        <!-- AUTOR -->
        <g id="Autor">
          <rect class="box" x="2360" y="5000" width="400" height="70" rx="4"/>
          <text class="small" x="2560" y="5040" text-anchor="middle">Autor</text>
          
          <ellipse class="oval" cx="2360" cy="5300" rx="130" ry="26"/><text class="mini" x="2360" y="5304" text-anchor="middle">ID_autor</text>
          <path class="edge" d="M2380 5070 L2376 5274" />
          
          <ellipse class="oval" cx="2760" cy="5300" rx="118" ry="26"/><text class="mini" x="2760" y="5304" text-anchor="middle">Nombre</text>
          <path class="edge" d="M2740 5070 L2750 5274" />
          
          <ellipse class="oval" cx="2560" cy="5500" rx="120" ry="26"/><text class="mini" x="2560" y="5504" text-anchor="middle">Apellido</text>
          <path class="edge" d="M2560 5070 L2560 5474" />
        </g>
        <path class="edge" d="M2540 4530 L2540 5000" /><text class="small" x="2550" y="4770">*</text>

        <!-- SE CLASIFICA (N:M) -> G√âNERO -->
        <g id="R_Clasifica">
          <polygon class="diamond" points="3750,4500 3790,4470 3830,4500 3790,4530"/>
          <text class="small" x="3790" y="4506" text-anchor="middle">Se clasifica</text>
          <text class="small" x="3830" y="4490">N:M</text>
        </g>
        <path class="edge" d="M3750 3070 L3750 4470" />
        <text class="small" x="3765" y="3800">*</text>

        <!-- G√âNERO -->
        <g id="Genero">
          <rect class="box" x="3590" y="5000" width="400" height="70" rx="4"/>
          <text class="small" x="3790" y="5040" text-anchor="middle">G√©nero</text>
          
          <ellipse class="oval" cx="3790" cy="5300" rx="136" ry="26"/><text class="mini" x="3790" y="5304" text-anchor="middle">ID_genero</text>
          <path class="edge" d="M3790 5070 L3790 5274" />
          
          <ellipse class="oval" cx="3790" cy="5500" rx="156" ry="26"/><text class="mini" x="3790" y="5504" text-anchor="middle">Descripcion</text>
          <path class="edge" d="M3790 5070 L3790 5474" />
        </g>
        <path class="edge" d="M3790 4530 L3790 5000" /><text class="small" x="3800" y="4770">*</text>

        <!-- TIENE (1:N) -> EJEMPLAR -->
        <g id="R_Tiene">
          <polygon class="diamond" points="5500,4500 5540,4470 5580,4500 5540,4530"/>
          <text class="small" x="5540" y="4506" text-anchor="middle">Tiene</text>
        </g>
        <path class="edge" d="M4000 3070 L4500 3070 L4500 4300 L5500 4300 L5500 4470" />
        <text class="small" x="4700" y="4000">1</text>

        <!-- EJEMPLAR -->
        <g id="Ejemplar">
          <rect class="box" x="5340" y="5000" width="450" height="70" rx="4"/>
          <text class="small" x="5565" y="5040" text-anchor="middle">Ejemplar</text>
          
          <ellipse class="oval" cx="5340" cy="5300" rx="132" ry="26"/><text class="mini" x="5340" y="5304" text-anchor="middle">ID_ejemplar</text>
          <path class="edge" d="M5360 5070 L5356 5274" />
          
          <ellipse class="oval" cx="5790" cy="5300" rx="160" ry="26"/><text class="mini" x="5790" y="5304" text-anchor="middle">CodigoBarras</text>
          <path class="edge" d="M5770 5070 L5780 5274" />
          
          <ellipse class="oval" cx="5340" cy="5500" rx="130" ry="26"/><text class="mini" x="5340" y="5504" text-anchor="middle">Ubicacion</text>
          <path class="edge" d="M5360 5070 L5356 5474" />
          
          <ellipse class="oval" cx="5790" cy="5500" rx="176" ry="26"/><text class="mini" x="5790" y="5504" text-anchor="middle">EstadoEjemplar</text>
          <path class="edge" d="M5770 5070 L5780 5474" />
        </g>
        <path class="edge" d="M5540 4530 L5540 5000" /><text class="small" x="5550" y="4770">*</text>

        <!-- CONTIENE (N:M) PR√âSTAMO->EJEMPLAR -->
        <g id="R_Contiene">
          <polygon class="diamond" points="8000,2200 8040,2170 8080,2200 8040,2230"/>
          <text class="small" x="8040" y="2206" text-anchor="middle">Contiene</text>
          <text class="small" x="8080" y="2190">N:M</text>
        </g>
        <path class="edge" d="M6500 860 L6500 1500 L8000 1500 L8000 2170" />
        <text class="small" x="6550" y="1300">*</text>
        <path class="edge" d="M8080 2200 L9000 2200 L9000 5300 L5790 5300" />
        <text class="small" x="8900" y="3750">*</text><text class="small" x="8000" y="3750">*</text>
      </svg>
    </div>

    <div class="status" id="status">üìä Zoom: 100% | Posici√≥n: (0, 0) | Arrastra para navegar</div>
  </div>

  <script>
    // Estado de vista
    let currentScale = 1, currentX = 0, currentY = 0, isDragging = false, startX = 0, startY = 0;
    let svg = null;

    // Funci√≥n para mostrar toast
    function toast(msg, type='success'){
      const n = document.createElement('div'); 
      n.className = `toast${type==='error'?' error':''}`;
      n.textContent = msg;
      document.body.appendChild(n); 
      setTimeout(()=>{ 
        n.style.animation = 'slideOut .25s ease'; 
        setTimeout(()=>n.remove(), 250); 
      }, 3000);
    }

    function setup() {
      svg = document.getElementById('erd');
      document.getElementById('loading').style.display = 'none';

      const container = document.getElementById('diagram');
      container.addEventListener('mousedown', startDrag);
      container.addEventListener('mousemove', drag);
      container.addEventListener('mouseup', endDrag);
      container.addEventListener('mouseleave', endDrag);
      container.addEventListener('wheel', handleWheel, { passive: false });
      container.addEventListener('dblclick', autoFit);
      document.addEventListener('keydown', handleKeyboard);

      // NO auto-fit inicial para evitar que se ejecute autom√°ticamente
      toast('‚úÖ Diagrama Chen cargado correctamente');
    }

    function startDrag(e){ isDragging = true; startX = e.clientX - currentX; startY = e.clientY - currentY; }
    function drag(e){ if(!isDragging) return; e.preventDefault(); currentX = e.clientX - startX; currentY = e.clientY - startY; updateTransform(); }
    function endDrag(){ isDragging = false; }

    function handleWheel(e){
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const rect = e.currentTarget.getBoundingClientRect();
      const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
      const newScale = Math.max(0.05, Math.min(8, currentScale * delta));
      const ratio = newScale / currentScale;
      currentX = mouseX - (mouseX - currentX) * ratio;
      currentY = mouseY - (mouseY - currentY) * ratio;
      currentScale = newScale; updateTransform();
    }

    function handleKeyboard(e){
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      const step = 60;
      switch(e.key){
        case 'ArrowUp': currentY += step; break;
        case 'ArrowDown': currentY -= step; break;
        case 'ArrowLeft': currentX += step; break;
        case 'ArrowRight': currentX -= step; break;
        case '+': zoomIn(); return;
        case '-': zoomOut(); return;
        case ' ': case 'f': e.preventDefault(); autoFit(); return;
        case 'r': resetView(); return;
        default: return;
      }
      e.preventDefault(); updateTransform();
    }

    function updateTransform(){ if(svg){ svg.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`; updateStatus(); } }
    function updateStatus(){ const z = Math.round(currentScale*100), x = Math.round(currentX), y = Math.round(currentY); document.getElementById('status').textContent = `üìä Zoom: ${z}% | Posici√≥n: (${x}, ${y}) | Arrastra para navegar`; }

    function autoFit(){
      if(!svg) return; try{
        const container = document.getElementById('diagram');
        const bbox = svg.getBBox();
        const r = container.getBoundingClientRect();
        const scaleX = (r.width - 40) / bbox.width;
        const scaleY = (r.height - 40) / bbox.height;
        const s = Math.min(scaleX, scaleY, 1.5);
        currentScale = s;
        currentX = (r.width - bbox.width * s) / 2 - bbox.x * s;
        currentY = (r.height - bbox.height * s) / 2 - bbox.y * s;
        updateTransform();
        toast('üéØ Vista ajustada autom√°ticamente');
      }catch{ resetView(); }
    }

    function zoomIn(){
      const c = document.getElementById('diagram').getBoundingClientRect();
      const cx = c.width/2, cy = c.height/2; const ns = Math.min(8, currentScale*1.2); const ratio = ns/currentScale;
      currentX = cx - (cx - currentX) * ratio; currentY = cy - (cy - currentY) * ratio; currentScale = ns; updateTransform();
    }
    function zoomOut(){
      const c = document.getElementById('diagram').getBoundingClientRect();
      const cx = c.width/2, cy = c.height/2; const ns = Math.max(0.05, currentScale*0.8); const ratio = ns/currentScale;
      currentX = cx - (cx - currentX) * ratio; currentY = cy - (cy - currentY) * ratio; currentScale = ns; updateTransform();
    }

    function resetView(){ currentScale = 1; currentX = 0; currentY = 0; updateTransform(); toast('‚Üª Vista restablecida'); }

    // Imprimir PDF
    function printDiagram(){
      if(!svg){ toast('‚ùå Espera a que el diagrama termine de cargar', 'error'); return; }
      toast('üñ®Ô∏è Abriendo di√°logo de impresi√≥n...');

      const originalTitle = document.title;
      document.title = 'Sistema_Biblioteca_ERD_Chen';
      
      const printStyles = document.createElement('style');
      printStyles.innerHTML = `
        @media print {
          body * { visibility: hidden; }
          #diagram, #diagram * { visibility: visible; }
          #diagram { 
            position: absolute; left: 0; top: 0; width: 100% !important; height: 100% !important; 
            transform: none !important; background: white;
          }
          #diagram svg {
            width: 100% !important; height: auto !important; max-width: none !important; 
            max-height: none !important; transform: none !important;
          }
          .instructions, .status, .loading { display: none !important; }
        }
      `;
      document.head.appendChild(printStyles);
      window.print();
      setTimeout(() => { document.head.removeChild(printStyles); document.title = originalTitle; }, 1000);
    }

    // Descargar imagen usando html2canvas
    async function downloadImage(){
      if(!svg){ toast('‚ùå Espera a que el diagrama termine de cargar', 'error'); return; }
      try{
        toast('üì∏ Generando imagen...');
        const container = document.getElementById('diagram');
        
        const canvas = await html2canvas(container, {
          backgroundColor: '#ffffff', scale: 2, useCORS: true, allowTaint: true, logging: false
        });
        
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url; link.download = 'Sistema_Biblioteca_ERD_Chen.png';
          link.click(); URL.revokeObjectURL(url);
          toast('‚úÖ Imagen descargada correctamente');
        }, 'image/png', 1.0);
        
      }catch(error){
        console.error('Error:', error);
        toast('‚ùå Error al generar imagen. Intentando m√©todo alternativo...', 'error');
        fallbackImageDownload();
      }
    }

    // M√©todo de respaldo
    function fallbackImageDownload(){
      try{
        const svgData = new XMLSerializer().serializeToString(svg);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const rect = svg.getBoundingClientRect();
        canvas.width = rect.width * 2; canvas.height = rect.height * 2;
        ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const img = new Image();
        img.onload = function(){
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const link = document.createElement('a');
          link.download = 'Sistema_Biblioteca_ERD_Chen_Alt.png';
          link.href = canvas.toDataURL('image/png'); link.click();
          toast('‚úÖ Imagen descargada (m√©todo alternativo)');
        };
        
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        img.src = URL.createObjectURL(svgBlob);
      }catch(error){ toast('‚ùå Error en m√©todo alternativo', 'error'); }
    }

    // Descargar SVG
    function downloadSVG(){
      if(!svg){ toast('‚ùå Espera a que el diagrama termine de cargar', 'error'); return; }
      try{
        toast('üìÑ Generando archivo SVG...');
        
        const svgClone = svg.cloneNode(true);
        const bbox = svg.getBBox();
        svgClone.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
        svgClone.setAttribute('width', bbox.width); svgClone.setAttribute('height', bbox.height);
        svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        
        const svgCode = new XMLSerializer().serializeToString(svgClone);
        const blob = new Blob([svgCode], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url; link.download = 'Sistema_Biblioteca_ERD_Chen.svg';
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        URL.revokeObjectURL(url);
        toast('‚úÖ Archivo SVG descargado correctamente');
      }catch(error){
        console.error('Error:', error); toast('‚ùå Error al descargar SVG', 'error');
      }
    }

    // Mostrar ayuda
    function showHelp(){
      const helpText = `üÜò M√âTODOS DE DESCARGA DISPONIBLES:

üì• IMG: Descarga imagen PNG de alta calidad
üìÑ SVG: Descarga archivo vectorial SVG  
üñ®Ô∏è PDF: Imprime o guarda como PDF

üìã M√âTODOS ALTERNATIVOS:
‚Ä¢ Clic derecho en diagrama ‚Üí "Guardar imagen como..."
‚Ä¢ Captura de pantalla: Win + Shift + S
‚Ä¢ F12 ‚Üí Console ‚Üí document.querySelector("#erd")
‚Ä¢ Ctrl + P ‚Üí "Guardar como PDF"

üéØ NAVEGACI√ìN:
‚Ä¢ Arrastrar: Mover diagrama
‚Ä¢ Rueda: Zoom in/out  
‚Ä¢ Doble clic: Auto-ajustar
‚Ä¢ Flechas: Mover con teclado

¬°M√∫ltiples opciones para asegurar que funcione! üí™`;
      alert(helpText);
    }

    document.addEventListener('DOMContentLoaded', () => setTimeout(setup, 200));
  </script>
</body>
</html>
