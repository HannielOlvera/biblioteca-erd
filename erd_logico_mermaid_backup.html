<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>ERD L√≥gico (Crow's Foot) - Biblioteca</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Diagrama l√≥gico Crow's Foot de la base de datos de Biblioteca, renderizado con Mermaid." />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3Eüîó%3C/text%3E%3C/svg%3E" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn--ghost">‚Üê Volver al √≠ndice</a>
        <header class="page"><h1 class="title">üîó Diagrama L√≥gico (Crow's Foot)</h1></header>

        <section class="notice">
            <h3>Modelo L√≥gico - Sistema de Biblioteca</h3>
            <p>Incluye PK/FK, relaciones N:M y cardinalidades. Puedes exportar el gr√°fico como PDF y navegar con pan/zoom.</p>
        </section>

        <div class="toolbar">
            <button class="btn" id="btnExportPdf">Exportar PDF</button>
            <button class="btn" id="zoomIn">Zoom +</button>
            <button class="btn" id="zoomOut">Zoom ‚àí</button>
            <button class="btn" id="reset">Reset</button>
            <label class="btn" style="user-select:none; cursor:pointer;">
              <input type="checkbox" id="autoPan" style="margin-right:8px"> Auto-pan con cursor
            </label>
        </div>

        <div class="diagram-container">
            <div class="mermaid" id="mmd">
                erDiagram
                    USUARIO {
                        int id_usuario PK
                        string nombre
                        string apellido
                        date fecha_nacimiento
                        string email
                        string telefono
                        enum genero
                        string direccion
                        int id_tipo_usuario FK
                    }
                    
                    TIPO_USUARIO {
                        int id_tipo_usuario PK
                        string descripcion
                        int limite_prestamos
                        int dias_prestamo
                    }
                    
                    LIBRO {
                        int id_libro PK
                        string titulo
                        string subtitulo
                        string isbn13
                        string isbn10
                        int edicion
                        int anio_publicacion
                        int id_editorial FK
                        int id_idioma FK
                        int id_tipo_libro FK
                    }
                    
                    EDITORIAL {
                        int id_editorial PK
                        string nombre
                        string pais
                        string sitio_web
                    }
                    
                    IDIOMA {
                        int id_idioma PK
                        string nombre
                        string codigo_iso
                    }
                    
                    TIPO_LIBRO {
                        int id_tipo_libro PK
                        string descripcion
                        int dias_prestamo_max
                    }
                    
                    AUTOR {
                        int id_autor PK
                        string nombre
                        string apellido
                        string nacionalidad
                        date fecha_nacimiento
                        date fecha_muerte
                    }
                    
                    LIBRO_AUTOR {
                        int id_libro FK
                        int id_autor FK
                        string rol
                    }
                    
                    GENERO {
                        int id_genero PK
                        string nombre
                        string descripcion
                    }
                    
                    LIBRO_GENERO {
                        int id_libro FK
                        int id_genero FK
                    }
                    
                    EJEMPLAR {
                        int id_ejemplar PK
                        int id_libro FK
                        string codigo_barras
                        string ubicacion
                        enum estado_ejemplar
                        date fecha_adquisicion
                        decimal precio_adquisicion
                    }
                    
                    PRESTAMO {
                        int id_prestamo PK
                        int id_usuario FK
                        date fecha_prestamo
                        date fecha_devolucion_esperada
                        date fecha_devolucion_real
                        enum status
                        decimal multa
                        string observaciones
                    }
                    
                    DETALLE_PRESTAMO {
                        int id_prestamo FK
                        int id_ejemplar FK
                        date fecha_devolucion_ejemplar
                        enum estado_devolucion
                    }
                    
                    MULTA {
                        int id_multa PK
                        int id_prestamo FK
                        decimal monto
                        string motivo
                        date fecha_generacion
                        date fecha_pago
                        enum estado_multa
                    }

                    %% Relaciones principales
                    USUARIO ||--o{ PRESTAMO : "realiza"
                    TIPO_USUARIO ||--o{ USUARIO : "clasifica"
                    
                    LIBRO ||--o{ EJEMPLAR : "tiene"
                    EDITORIAL ||--o{ LIBRO : "publica"
                    IDIOMA ||--o{ LIBRO : "escrito_en"
                    TIPO_LIBRO ||--o{ LIBRO : "categoriza"
                    
                    LIBRO ||--o{ LIBRO_AUTOR : "tiene"
                    AUTOR ||--o{ LIBRO_AUTOR : "escribe"
                    
                    LIBRO ||--o{ LIBRO_GENERO : "pertenece"
                    GENERO ||--o{ LIBRO_GENERO : "clasifica"
                    
                    PRESTAMO ||--o{ DETALLE_PRESTAMO : "contiene"
                    EJEMPLAR ||--o{ DETALLE_PRESTAMO : "prestado_en"
                    
                    PRESTAMO ||--o{ MULTA : "genera"
            </div>
        </div>
    </div>

    <!-- Librer√≠as para exportaci√≥n a PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.1/dist/svg2pdf.umd.min.js"></script>
    
    <!-- Sistema avanzado de funcionalidades -->
    <script src="assets/js/notifications.js"></script>
    <script src="assets/js/pdf-export.js"></script>
    <script src="assets/js/advanced-pan-zoom.js"></script>
    <script src="assets/js/keyboard-shortcuts.js"></script>

    <script>
        // Initialize Mermaid with professional theme
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'default', 
            themeVariables: {
                primaryColor: '#e7f0ff', 
                primaryTextColor: '#111827', 
                primaryBorderColor: '#1976d2',
                lineColor: '#374151', 
                sectionBkgColor: '#f8fafc', 
                altSectionBkgColor: '#ffffff', 
                gridColor: '#e5e7eb'
            }
        });

        let mermaidPanZoom = null;
        let keyboard = null;

        // Enhanced setup for Mermaid diagrams
        function ensureViewBox(svg){
            if(!svg.getAttribute('viewBox')){
                const w = svg.width && svg.width.baseVal ? svg.width.baseVal.value : 2000;
                const h = svg.height && svg.height.baseVal ? svg.height.baseVal.value : 1200;
                svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
            }
        }

        function setupAdvancedPanZoom(){
            const svg = document.querySelector('#mmd svg');
            if(!svg) {
                console.warn('Mermaid SVG not found, retrying...');
                setTimeout(setupAdvancedPanZoom, 100);
                return;
            }
            
            ensureViewBox(svg);
            
            // Initialize advanced pan/zoom for Mermaid SVG
            mermaidPanZoom = new SVGPanZoom(svg, {
                enablePan: true,
                enableZoom: true,
                enableAutoFit: true,
                enableSmoothing: true,
                enableAutoPan: false,
                smoothingFactor: 0.14,
                zoomStep: 0.2,
                maxZoom: 8,
                minZoom: 0.1,
                edgePanSpeed: 25,
                edgePanMargin: 50,
                inertia: 0.9,
                friction: 0.85,
                doubleClickZoom: true,
                mouseWheelZoom: true
            });
            
            // Initialize keyboard shortcuts
            keyboard = new KeyboardShortcuts(mermaidPanZoom);
            
            // Status bar updates
            const statusBar = document.getElementById('statusBar');
            function updateStatus() {
                if (!mermaidPanZoom) return;
                const zoom = Math.round(mermaidPanZoom.state.scale * 100);
                const x = Math.round(mermaidPanZoom.state.x);
                const y = Math.round(mermaidPanZoom.state.y);
                statusBar.textContent = `Zoom: ${zoom}% | Posici√≥n: (${x}, ${y}) | üéØ Alt+H para ayuda`;
            }
            
            setInterval(updateStatus, 100);
            
            // Success notification
            window.BibliotecaERD?.showNotification(
                'Diagrama Crow\'s Foot cargado con navegaci√≥n avanzada', 
                'success', 
                3000,
                'Sistema Listo'
            );
            
            console.log('üéØ Mermaid ERD initialized with advanced pan/zoom');
        }
          const svg = document.querySelector('#mmd svg');
          if(!svg) return;
          ensureViewBox(svg);
          const vb = svg.getAttribute('viewBox').split(/[ ,]+/).map(Number);
          const content = { x: vb[0], y: vb[1], w: vb[2], h: vb[3] };
          const view = { ...content };
          const container = document.querySelector('.diagram-container');

          function apply(){ svg.setAttribute('viewBox', `${view.x} ${view.y} ${view.w} ${view.h}`); }
          function clamp(){
            if(view.w > content.w) view.w = content.w; if(view.h > content.h) view.h = content.h;
            const maxX = Math.max(content.x, content.x + content.w - view.w);
            const maxY = Math.max(content.y, content.y + content.h - view.h);
            if(view.x < content.x) view.x = content.x; if(view.y < content.y) view.y = content.y;
            if(view.x > maxX) view.x = maxX; if(view.y > maxY) view.y = maxY;
          }
          function clientScale(){ const r = svg.getBoundingClientRect(); return { sx: view.w / r.width, sy: view.h / r.height }; }

          let dragging=false, start={mx:0,my:0,x:0,y:0};
          container.addEventListener('mousedown', e=>{ dragging=true; start={mx:e.clientX,my:e.clientY,x:view.x,y:view.y}; container.style.cursor='grabbing'; e.preventDefault(); });
          window.addEventListener('mousemove', e=>{ if(!dragging) return; const {sx,sy}=clientScale(); view.x=start.x-(e.clientX-start.mx)*sx; view.y=start.y-(e.clientY-start.my)*sy; clamp(); apply(); });
          window.addEventListener('mouseup', ()=>{ dragging=false; container.style.cursor='default'; });

          svg.addEventListener('wheel', e=>{ e.preventDefault(); const f = e.deltaY<0?0.9:1.1; const cx=view.x+view.w/2; const cy=view.y+view.h/2; view.w=Math.max(200, Math.min(content.w, view.w*f)); view.h=Math.max(200, Math.min(content.h, view.h*f)); view.x=cx-view.w/2; view.y=cy-view.h/2; clamp(); apply(); }, {passive:false});

          const autoPan = document.getElementById('autoPan');
          container.addEventListener('mousemove', e=>{
            if(!autoPan || !autoPan.checked || dragging) return;
            const r = svg.getBoundingClientRect(); const m=40; const {sx,sy}=clientScale(); let moved=false;
            if(e.clientX < r.left + m) { view.x -= 20*sx; moved=true; }
            if(e.clientX > r.right - m){ view.x += 20*sx; moved=true; }
            if(e.clientY < r.top + m)  { view.y -= 20*sy; moved=true; }
            if(e.clientY > r.bottom - m){ view.y += 20*sy; moved=true; }
            if(moved){ clamp(); apply(); }
          });

          document.getElementById('zoomIn').addEventListener('click', ()=> svg.dispatchEvent(new WheelEvent('wheel', { deltaY: -100 })));
          document.getElementById('zoomOut').addEventListener('click', ()=> svg.dispatchEvent(new WheelEvent('wheel', { deltaY: 100 })));
          document.getElementById('reset').addEventListener('click', ()=>{ view.x=content.x; view.y=content.y; view.w=content.w; view.h=content.h; apply(); });
          document.getElementById('btnExportPdf').addEventListener('click', ()=>{ if(window.exportSvgToPdf) window.exportSvgToPdf(svg, 'ERD_Logico.pdf'); else alert('Exportaci√≥n PDF no disponible.'); });

          apply();
        }

        // Espera a que Mermaid renderice
        document.addEventListener('DOMContentLoaded', ()=>{
          const observer = new MutationObserver(()=>{
            const svg = document.querySelector('#mmd svg');
            if(svg){ setupPanZoom(); observer.disconnect(); }
          });
          observer.observe(document.getElementById('mmd'), { childList: true, subtree: true });
        });
    </script>
    <script src="assets/js/main.js" defer></script>
</body>
</html>
