<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>ERD L√≥gico (Crow's Foot) - Biblioteca</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Diagrama l√≥gico Crow's Foot de la base de datos de Biblioteca, renderizado con Mermaid." />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3Eüîó%3C/text%3E%3C/svg%3E" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="btn btn--ghost">‚Üê Volver al √≠ndice</a>
        <header class="page"><h1 class="title">üîó Diagrama L√≥gico (Crow's Foot)</h1></header>

        <section class="notice">
            <h3>Modelo L√≥gico - Sistema de Biblioteca</h3>
            <p>Incluye PK/FK, relaciones N:M y cardinalidades. Puedes exportar el gr√°fico como SVG.</p>
        </section>

        <div class="toolbar">
            <button class="btn" id="btnExportSvg">Exportar SVG</button>
        </div>

        <div class="diagram-container">
            <div class="mermaid" id="mmd">
                erDiagram
                    USUARIO {
                        int id_usuario PK
                        string nombre
                        string apellido
                        date fecha_nacimiento
                        string email
                        string telefono
                        enum genero
                        string direccion
                        int id_tipo_usuario FK
                    }
                    
                    TIPO_USUARIO {
                        int id_tipo_usuario PK
                        string descripcion
                        int limite_prestamos
                        int dias_prestamo
                    }
                    
                    LIBRO {
                        int id_libro PK
                        string titulo
                        string subtitulo
                        string isbn13
                        string isbn10
                        int edicion
                        int anio_publicacion
                        int id_editorial FK
                        int id_idioma FK
                        int id_tipo_libro FK
                    }
                    
                    EDITORIAL {
                        int id_editorial PK
                        string nombre
                        string pais
                        string sitio_web
                    }
                    
                    IDIOMA {
                        int id_idioma PK
                        string nombre
                        string codigo_iso
                    }
                    
                    TIPO_LIBRO {
                        int id_tipo_libro PK
                        string descripcion
                        int dias_prestamo_max
                    }
                    
                    AUTOR {
                        int id_autor PK
                        string nombre
                        string apellido
                        string nacionalidad
                        date fecha_nacimiento
                        date fecha_muerte
                    }
                    
                    LIBRO_AUTOR {
                        int id_libro FK
                        int id_autor FK
                        string rol
                    }
                    
                    GENERO {
                        int id_genero PK
                        string nombre
                        string descripcion
                    }
                    
                    LIBRO_GENERO {
                        int id_libro FK
                        int id_genero FK
                    }
                    
                    EJEMPLAR {
                        int id_ejemplar PK
                        int id_libro FK
                        string codigo_barras
                        string ubicacion
                        enum estado_ejemplar
                        date fecha_adquisicion
                        decimal precio_adquisicion
                    }
                    
                    PRESTAMO {
                        int id_prestamo PK
                        int id_usuario FK
                        date fecha_prestamo
                        date fecha_devolucion_esperada
                        date fecha_devolucion_real
                        enum status
                        decimal multa
                        string observaciones
                    }
                    
                    DETALLE_PRESTAMO {
                        int id_prestamo FK
                        int id_ejemplar FK
                        date fecha_devolucion_ejemplar
                        enum estado_devolucion
                    }
                    
                    MULTA {
                        int id_multa PK
                        int id_prestamo FK
                        decimal monto
                        string motivo
                        date fecha_generacion
                        date fecha_pago
                        enum estado_multa
                    }

                    %% Relaciones principales
                    USUARIO ||--o{ PRESTAMO : "realiza"
                    TIPO_USUARIO ||--o{ USUARIO : "clasifica"
                    
                    LIBRO ||--o{ EJEMPLAR : "tiene"
                    EDITORIAL ||--o{ LIBRO : "publica"
                    IDIOMA ||--o{ LIBRO : "escrito_en"
                    TIPO_LIBRO ||--o{ LIBRO : "categoriza"
                    
                    LIBRO ||--o{ LIBRO_AUTOR : "tiene"
                    AUTOR ||--o{ LIBRO_AUTOR : "escribe"
                    
                    LIBRO ||--o{ LIBRO_GENERO : "pertenece"
                    GENERO ||--o{ LIBRO_GENERO : "clasifica"
                    
                    PRESTAMO ||--o{ DETALLE_PRESTAMO : "contiene"
                    EJEMPLAR ||--o{ DETALLE_PRESTAMO : "prestado_en"
                    
                    PRESTAMO ||--o{ MULTA : "genera"
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', themeVariables: {
            primaryColor: '#e7f0ff', primaryTextColor: '#111827', primaryBorderColor: '#1976d2',
            lineColor: '#374151', sectionBkgColor: '#f8fafc', altSectionBkgColor: '#ffffff', gridColor: '#e5e7eb'
        }});

        // Export current Mermaid diagram as SVG
        document.getElementById('btnExportSvg').addEventListener('click', async () => {
            // Mermaid renders to an SVG inside .mermaid
            const svg = document.querySelector('#mmd svg');
            if(!svg){ alert('El diagrama a√∫n no se ha renderizado.'); return; }
            const xml = new XMLSerializer().serializeToString(svg);
            const blob = new Blob(['<?xml version="1.0" encoding="UTF-8"?>\n' + xml], {type:'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'ERD_Logico_Mermaid.svg';
            document.body.appendChild(a); a.click();
            setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        });
    </script>
    <script src="assets/js/main.js" defer></script>
</body>
</html>
